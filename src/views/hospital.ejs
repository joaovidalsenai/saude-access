<!DOCTYPE html>
<html lang="pt-br" data-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/styleGenerico.css" />
    <link rel="stylesheet" href="/css/hospitais.css" />
    <title>Saúde Access</title>
    <link rel="stylesheet" href="/css/protected.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/js/global.js"></script>
    <script src="/js/auth-utils.js" defer></script>
</head> 
<body class="protected">
    <header>
        <h1><%= titulo %></h1>
    </header>
    <main>
        <div class="container-hospitais">
            <div class="div-butoes" id="lista-hospitais-container">
                <p>Obtendo sua localização para encontrar hospitais próximos...</p>
            </div>
        </div>
    </main>
    <%- include ('partials/navbar.ejs')%>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // Pega as coordenadas do hospital que foram renderizadas pelo EJS
            const hospitalLat = <%= hospital.HOSPITAL_LATITUDE %>;
            const hospitalLng = <%= hospital.HOSPITAL_LONGITUDE %>;

            // Função para calcular distância
            function calcularDistancia(lat1, lon1, lat2, lon2) {
                if ((lat1 == lat2) && (lon1 == lon2)) { return 0; }
                const radlat1 = Math.PI * lat1/180;
                const radlat2 = Math.PI * lat2/180;
                const theta = lon1-lon2;
                const radtheta = Math.PI * theta/180;
                let dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
                if (dist > 1) { dist = 1; }
                dist = Math.acos(dist);
                dist = dist * 180/Math.PI;
                dist = dist * 60 * 1.1515 * 1.609344;
                return dist.toFixed(1);
            }

            // Seleciona o container de endereço e cria o elemento para a distância
            const containerEndereco = document.querySelector('.endereco-info');
            const distanciaValorElement = document.getElementById('distancia-valor'); // Supondo que você tenha um elemento com este ID

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    const { latitude, longitude } = position.coords;
                    const distancia = calcularDistancia(latitude, longitude, hospitalLat, hospitalLng);
                    if (distanciaValorElement) {
                        distanciaValorElement.textContent = `${distancia} km de você`;
                    }
                }, error => {
                    if (distanciaValorElement) {
                        distanciaValorElement.textContent = 'Não foi possível calcular';
                    }
                });
            } else {
                if (distanciaValorElement) {
                    distanciaValorElement.textContent = 'Geolocalização indisponível';
                }
            }
        });
    </script>
</body>
</html>