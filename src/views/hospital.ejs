<!DOCTYPE html>
<html lang="pt-br" data-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/styleGenerico.css" />
    <link rel="stylesheet" href="/css/hospital.css" />
    <title>Saúde Access - Detalhes</title>
    <link rel="stylesheet" href="/css/protected.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="/js/global.js"></script>
    <script src="/js/auth-utils.js" defer></script>
</head>
<body class="protected">
    <header>
        <h1><%= hospital.hospital_nome %></h1>
    </header>
    <main>
        <div class="container-detalhes-hospital">

            <% if (hospital.hospital_endereco) { %>
                <div id="hospital-data"
                     data-lat="<%= hospital.hospital_endereco.hospital_latitude %>"
                     data-lng="<%= hospital.hospital_endereco.hospital_longitude %>"
                     style="display: none;">
                </div>

                <section class="info-hospital">
                    <h2>Localização</h2>
                    <p class="endereco-info"><%= hospital.hospital_endereco.logradouro || 'Endereço não informado' %></p>
                    <p id="distancia-valor" class="distancia-info">Calculando sua distância...</p>
                </section>
            <% } %>

            <section class="avaliacoes-container">
                <h2>Avaliações</h2>
                <% if (hospital.avaliacao && hospital.avaliacao.length > 0) { %>
                    <% hospital.avaliacao.forEach(ava => { %>
                        <div class="avaliacao-card">
                            <p><strong>Nota:</strong> <%= ava.nota %> / 5</p>
                            <p class="comentario">"<%= ava.comentario %>"</p>
                        </div>
                    <% }); %>
                <% } else { %>
                    <p>Este hospital ainda não possui avaliações.</p>
                <% } %>
            </section>

            <a href="/avaliar?id=<%= hospital.hospital_id %>" class="btn-acao-principal">Avaliar este Hospital</a>
        </div>
    </main>
    <%- include ('partials/navbar.ejs') %>

    <% if (hospital.hospital_endereco) { %>
        <script>
            document.addEventListener('DOMContentLoaded', () => {
                /*
                  PASSO 2: O JavaScript agora lê os dados diretamente do elemento HTML.
                  Este código é JavaScript "puro", sem nenhuma tag EJS, o que
                  resolve completamente os erros de sintaxe do seu editor.
                */
                const dataContainer = document.getElementById('hospital-data');
                const hospitalLat = parseFloat(dataContainer.dataset.lat);
                const hospitalLng = parseFloat(dataContainer.dataset.lng);
                const distanciaElement = document.getElementById('distancia-valor');

                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(position => {
                        const { latitude, longitude } = position.coords;
                        const distancia = calcularDistanciaHaversine(latitude, longitude, hospitalLat, hospitalLng);
                        distanciaElement.textContent = `Fica a ${distancia.toFixed(1)} km de você`;
                    }, () => {
                        distanciaElement.textContent = 'Não foi possível calcular a distância (localização negada).';
                    });
                } else {
                    distanciaElement.textContent = 'Geolocalização não é suportada pelo seu navegador.';
                }
            });

            function calcularDistanciaHaversine(lat1, lon1, lat2, lon2) {
                const R = 6371;
                const dLat = (lat2 - lat1) * (Math.PI / 180);
                const dLon = (lon2 - lon1) * (Math.PI / 180);
                const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos((lat1 * Math.PI) / 180) * Math.cos((lat2 * Math.PI) / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                return R * c;
            }
        </script>
    <% } %>
</body>
</html>