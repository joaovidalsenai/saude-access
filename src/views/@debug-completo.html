<!DOCTYPE html>
<html>
<head>
    <title>Debug Completo</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div style="padding: 20px; font-family: Arial, sans-serif;">
        <h1>üîç Debug Completo do Sistema</h1>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0;">
            <h3>1. Status do Supabase:</h3>
            <div id="supabase-status">Verificando...</div>
        </div>

        <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 20px 0;">
            <h3>2. Login R√°pido:</h3>
            <input type="email" id="debug-email" placeholder="seu@email.com" style="margin: 5px; padding: 8px;">
            <input type="password" id="debug-senha" placeholder="senha" style="margin: 5px; padding: 8px;">
            <button onclick="loginDebug()" style="margin: 5px; padding: 8px 15px;">Login</button>
        </div>

        <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 20px 0;">
            <h3>3. Testes:</h3>
            <button onclick="testarSessao()" style="margin: 5px; padding: 8px;">Verificar Sess√£o</button>
            <button onclick="testarLocalStorage()" style="margin: 5px; padding: 8px;">Ver localStorage</button>
            <button onclick="simularProtecao()" style="margin: 5px; padding: 8px;">Simular Prote√ß√£o</button>
            <button onclick="irParaPaginaProtegida()" style="margin: 5px; padding: 8px;">Ir para P√°gina Protegida</button>
            <button onclick="fazerLogout()" style="margin: 5px; padding: 8px;">Logout</button>
        </div>

        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0; max-height: 400px; overflow-y: auto;">
            <h3>4. Logs:</h3>
            <div id="debug-logs"></div>
        </div>
    </div>

    <script>
        let supabase = null

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString()
            const color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#6c757d'
            
            const logDiv = document.getElementById('debug-logs')
            logDiv.innerHTML += `<div style="color: ${color}; margin: 3px 0; font-size: 14px;">[${timestamp}] ${message}</div>`
            logDiv.scrollTop = logDiv.scrollHeight
            
            console.log(message)
        }

        async function initSupabase() {
            try {
                log('üîß Inicializando Supabase...')
                const response = await fetch('/api/config')
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`)
                }
                
                const config = await response.json()
                log(`üìã Config recebida - URL: ${config.supabaseUrl}`)
                log(`üîë Key: ${config.supabaseAnonKey.substring(0, 20)}...`)
                
                supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseAnonKey)
                
                // Testar se o cliente funciona
                const { data, error } = await supabase.auth.getSession()
                if (error) {
                    throw new Error(`Erro no cliente Supabase: ${error.message}`)
                }
                
                log('‚úÖ Supabase inicializado com sucesso', 'success')
                document.getElementById('supabase-status').innerHTML = '<span style="color: green;">‚úÖ FUNCIONANDO</span>'
                return true
                
            } catch (error) {
                log(`‚ùå Erro ao inicializar Supabase: ${error.message}`, 'error')
                document.getElementById('supabase-status').innerHTML = `<span style="color: red;">‚ùå ERRO: ${error.message}</span>`
                return false
            }
        }

        async function loginDebug() {
            const email = document.getElementById('debug-email').value
            const senha = document.getElementById('debug-senha').value

            if (!email || !senha) {
                log('‚ùå Preencha email e senha', 'error')
                return
            }

            if (!supabase) {
                const init = await initSupabase()
                if (!init) return
            }

            try {
                log(`üîê Fazendo login com: ${email}`)
                
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: senha,
                })

                if (error) {
                    log(`‚ùå Erro no login: ${error.message}`, 'error')
                } else {
                    log(`‚úÖ Login realizado! Usu√°rio: ${data.user.email}`, 'success')
                    log(`üÜî User ID: ${data.user.id}`)
                    log(`‚è∞ Session expira: ${new Date(data.session.expires_at * 1000).toLocaleString()}`)
                    
                    // Verificar imediatamente se a sess√£o foi salva
                    setTimeout(testarSessao, 1000)
                }
            } catch (error) {
                log(`‚ùå Erro cr√≠tico: ${error.message}`, 'error')
            }
        }

        async function testarSessao() {
            if (!supabase) {
                await initSupabase()
            }

            try {
                log('üîç Testando sess√£o atual...')
                const { data: { session }, error } = await supabase.auth.getSession()

                if (error) {
                    log(`‚ùå Erro ao verificar sess√£o: ${error.message}`, 'error')
                    return
                }

                if (session) {
                    log(`‚úÖ SESS√ÉO ATIVA: ${session.user.email}`, 'success')
                    log(`‚è∞ Expira em: ${new Date(session.expires_at * 1000).toLocaleString()}`)
                    log(`üîë Access Token: ${session.access_token.substring(0, 30)}...`)
                } else {
                    log('‚ùå NENHUMA SESS√ÉO ENCONTRADA', 'error')
                }
            } catch (error) {
                log(`‚ùå Erro cr√≠tico na verifica√ß√£o: ${error.message}`, 'error')
            }
        }

        function testarLocalStorage() {
            log('üóÇÔ∏è Verificando localStorage...')
            
            const allKeys = Object.keys(localStorage)
            log(`üìä Total de chaves no localStorage: ${allKeys.length}`)
            
            const supabaseKeys = allKeys.filter(key => 
                key.includes('supabase') || key.includes('sb-')
            )
            
            if (supabaseKeys.length === 0) {
                log('‚ùå Nenhuma chave do Supabase no localStorage', 'error')
            } else {
                log(`‚úÖ Encontradas ${supabaseKeys.length} chaves do Supabase:`, 'success')
                supabaseKeys.forEach(key => {
                    const value = localStorage.getItem(key)
                    const preview = value ? value.substring(0, 50) + '...' : 'VAZIO'
                    log(`   üìù ${key}: ${preview}`)
                })
            }
        }

        async function simularProtecao() {
            log('üõ°Ô∏è Simulando l√≥gica de prote√ß√£o...')
            
            if (!supabase) await initSupabase()
            
            const { data: { session } } = await supabase.auth.getSession()
            
            if (session) {
                log('‚úÖ PROTE√á√ÉO: ACESSO PERMITIDO', 'success')
                log(`üë§ Usu√°rio logado: ${session.user.email}`)
            } else {
                log('‚ùå PROTE√á√ÉO: ACESSO NEGADO - Redirecionaria para login', 'error')
            }
        }

        function irParaPaginaProtegida() {
            log('üîÑ Redirecionando para p√°gina protegida...')
            window.location.href = '/teste-protegido'
        }

        async function fazerLogout() {
            if (!supabase) await initSupabase()
            
            try {
                log('üö™ Fazendo logout...')
                await supabase.auth.signOut()
                log('‚úÖ Logout realizado', 'success')
                setTimeout(testarSessao, 1000)
            } catch (error) {
                log(`‚ùå Erro no logout: ${error.message}`, 'error')
            }
        }

        // Inicializar ao carregar
        document.addEventListener('DOMContentLoaded', async () => {
            await initSupabase()
            await testarSessao()
            testarLocalStorage()
            
            // Escutar mudan√ßas de autentica√ß√£o
            if (supabase) {
                supabase.auth.onAuthStateChange((event, session) => {
                    log(`üîÑ Mudan√ßa de estado: ${event}`)
                    if (session) {
                        log(`‚úÖ Nova sess√£o: ${session.user.email}`, 'success')
                    } else {
                        log('‚ùå Sess√£o removida', 'error')
                    }
                })
            }
        })
    </script>
</body>
</html>