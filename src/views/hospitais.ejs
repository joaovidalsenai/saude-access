<!DOCTYPE html>
<html lang="pt-br" data-theme="light">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/css/styleGenerico.css" />
    <link rel="stylesheet" href="/css/hospitais.css" />
    <title>Saúde Access</title>
    <link rel="stylesheet" href="/css/protected.css" />
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/global.js"></script>
    <script src="js/auth-utils.js" defer></script>
    <style>
        .distancia-badge {
            display: inline-block;
            background-color: #007bff;
            color: white;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-top: 6px;
            font-weight: 500;
        }
        .distancia-carregando {
            color: #999;
        }
    </style>
</head> 
<body class="protected">
    <header>
        <h1><%= titulo %></h1>
        <% if (locals.erro) { %><div style="background-color: #ffdddd; color: #b71c1c; padding: 15px; text-align: center; margin: 1rem; border: 1px solid #b71c1c; border-radius: 8px;"><strong>Erro:</strong> <%= erro %></div><% } %>
    </header>
    <main>
        <form action="#" class="form-busca-hospital">
            <input
                type="search"
                name="pesquisar-hospitais"
                class="inp-busca-hospital"
                placeholder="Pesquisar hospital"
                autocomplete="off"
            />
            <button type="submit" class="btn-busca-hospital" aria-label="Pesquisar">
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="32"
                    height="32"
                    fill="currentColor"
                    viewBox="0 0 256 256"
                >
                    <path
                        d="M229.66,218.34l-50.07-50.06a88.11,88.11,0,1,0-11.31,11.31l50.06,50.07a8,8,0,0,0,11.32-11.32ZM40,112a72,72,0,1,1,72,72A72.08,72.08,0,0,1,40,112Z"
                    ></path>
                </svg>
            </button>
        </form>
        
        <div class="container-hospitais">
            <div class="div-butoes">
                <% hospitais.forEach(hospital => { %>
                    <a href="/hospital?id=<%= hospital.id %>" class="botao-hospital" data-hospital-id="<%= hospital.id %>" data-lat="<%= hospital.lat || '' %>" data-lng="<%= hospital.lng || '' %>">
                        <span class="botao-hospital-nota rating-<%= Math.floor(hospital.nota) %>">
                            <%= hospital.nota %>
                        </span>
                        <span class="botao-hospital-nome"><%= hospital.nome %></span>
                        <% if (hospital.lat && hospital.lng) { %>
                            <span class="distancia-badge distancia-carregando">Calculando...</span>
                        <% } %>
                    </a>
                <% }); %>
            </div>
            <p id="nenhum-hospital-encontrado" style="display: none; text-align: center; margin-top: 2rem;">Nenhum hospital encontrado.</p>
        </div>
    </main>
    <%- include ('partials/navbar.ejs') %>
    <script>
        // Calcular distâncias dos hospitais quando a página carregar
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const minhaLocalizacao = await mapsAPI.obterLocalizacaoAtual();
                const botoes = document.querySelectorAll('.botao-hospital[data-lat][data-lng]');

                botoes.forEach(async (botao) => {
                    const lat = parseFloat(botao.dataset.lat);
                    const lng = parseFloat(botao.dataset.lng);
                    const badge = botao.querySelector('.distancia-badge');

                    if (lat && lng && badge) {
                        try {
                            const resultado = await mapsAPI.calcularDistancia(
                                minhaLocalizacao,
                                { lat, lng }
                            );

                            badge.textContent = `${resultado.distancia.texto} • ${resultado.duracao.texto}`;
                            badge.classList.remove('distancia-carregando');
                        } catch (erro) {
                            console.error('Erro ao calcular distância:', erro);
                            badge.textContent = 'Erro ao calcular';
                            badge.classList.remove('distancia-carregando');
                        }
                    }
                });

            } catch (erro) {
                console.error('Erro ao obter localização:', erro);
                // Continuar mesmo sem localização (graceful fallback)
            }
        });
    </script>
</body>
</html>

