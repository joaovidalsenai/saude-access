<!DOCTYPE html>
<html>
<head>
    <title>Debug Sess√£o</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div style="padding: 20px; font-family: Arial, sans-serif; max-width: 800px;">
        <h1>üîç Debug de Sess√£o</h1>
        
        <div style="background: #f8f9fa; padding: 15px; border-radius: 5px; margin: 20px 0;">
            <h3>Status da Sess√£o:</h3>
            <div id="session-status">Verificando...</div>
        </div>

        <div style="background: #e3f2fd; padding: 15px; border-radius: 5px; margin: 20px 0;">
            <h3>Fazer Login:</h3>
            <input type="email" id="email" placeholder="seu@email.com" style="margin: 5px; padding: 8px; width: 200px;">
            <input type="password" id="password" placeholder="senha" style="margin: 5px; padding: 8px; width: 200px;">
            <button onclick="fazerLogin()" style="margin: 5px; padding: 8px 15px;">Login</button>
        </div>

        <div style="margin: 20px 0;">
            <button onclick="verificarSessao()" style="margin: 5px; padding: 10px;">Verificar Sess√£o</button>
            <button onclick="verificarLocalStorage()" style="margin: 5px; padding: 10px;">Ver localStorage</button>
            <button onclick="fazerLogout()" style="margin: 5px; padding: 10px;">Logout</button>
            <button onclick="testarProtecao()" style="margin: 5px; padding: 10px;">Testar Prote√ß√£o</button>
        </div>

        <div style="background: #fff3cd; padding: 15px; border-radius: 5px; margin: 20px 0; max-height: 400px; overflow-y: auto;">
            <h3>Logs:</h3>
            <div id="logs"></div>
        </div>
    </div>

    <script>
        let supabase = null

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString()
            const color = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : '#6c757d'
            
            document.getElementById('logs').innerHTML += 
                `<div style="color: ${color}; margin: 5px 0;">[${timestamp}] ${message}</div>`
            
            console.log(message)
        }

        async function initSupabase() {
            try {
                log('üîß Inicializando Supabase...')
                const response = await fetch('/api/config')
                const config = await response.json()
                
                log(`üìã URL: ${config.supabaseUrl}`)
                log(`üîë Key: ${config.supabaseAnonKey.substring(0, 20)}...`)
                
                supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseAnonKey)
                log('‚úÖ Supabase inicializado com sucesso', 'success')
                
                return true
            } catch (error) {
                log(`‚ùå Erro ao inicializar Supabase: ${error.message}`, 'error')
                return false
            }
        }

        async function verificarSessao() {
            if (!supabase) {
                const init = await initSupabase()
                if (!init) return
            }

            try {
                log('üîç Verificando sess√£o...')
                
                const { data: { session }, error } = await supabase.auth.getSession()
                
                if (error) {
                    log(`‚ùå Erro na verifica√ß√£o: ${error.message}`, 'error')
                    document.getElementById('session-status').innerHTML = `<span style="color: red;">Erro: ${error.message}</span>`
                    return
                }

                if (session) {
                    log(`‚úÖ Sess√£o encontrada! Usu√°rio: ${session.user.email}`, 'success')
                    log(`üïí Expira em: ${new Date(session.expires_at * 1000).toLocaleString()}`)
                    
                    document.getElementById('session-status').innerHTML = `
                        <span style="color: green;">‚úÖ LOGADO</span><br>
                        <strong>Email:</strong> ${session.user.email}<br>
                        <strong>ID:</strong> ${session.user.id}<br>
                        <strong>Expira:</strong> ${new Date(session.expires_at * 1000).toLocaleString()}
                    `
                } else {
                    log('‚ùå Nenhuma sess√£o encontrada', 'error')
                    document.getElementById('session-status').innerHTML = '<span style="color: red;">‚ùå N√ÉO LOGADO</span>'
                }

            } catch (error) {
                log(`‚ùå Erro cr√≠tico: ${error.message}`, 'error')
            }
        }

        async function fazerLogin() {
            const email = document.getElementById('email').value
            const password = document.getElementById('password').value

            if (!email || !password) {
                log('‚ùå Preencha email e senha', 'error')
                return
            }

            if (!supabase) await initSupabase()

            try {
                log(`üîê Tentando login com: ${email}`)
                
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password,
                })

                if (error) {
                    log(`‚ùå Erro no login: ${error.message}`, 'error')
                } else {
                    log('‚úÖ Login realizado com sucesso!', 'success')
                    setTimeout(verificarSessao, 1000)
                }
            } catch (error) {
                log(`‚ùå Erro cr√≠tico no login: ${error.message}`, 'error')
            }
        }

        async function fazerLogout() {
            if (!supabase) await initSupabase()

            try {
                log('üö™ Fazendo logout...')
                const { error } = await supabase.auth.signOut()

                if (error) {
                    log(`‚ùå Erro no logout: ${error.message}`, 'error')
                } else {
                    log('‚úÖ Logout realizado', 'success')
                    setTimeout(verificarSessao, 1000)
                }
            } catch (error) {
                log(`‚ùå Erro no logout: ${error.message}`, 'error')
            }
        }

        function verificarLocalStorage() {
            log('üóÇÔ∏è Verificando localStorage...')
            
            const keys = Object.keys(localStorage)
            const supabaseKeys = keys.filter(key => 
                key.includes('supabase') || key.includes('sb-')
            )
            
            if (supabaseKeys.length === 0) {
                log('‚ùå Nenhuma chave do Supabase encontrada no localStorage', 'error')
            } else {
                log(`‚úÖ Encontradas ${supabaseKeys.length} chaves do Supabase:`, 'success')
                supabaseKeys.forEach(key => {
                    const value = localStorage.getItem(key)
                    log(`   üìù ${key}: ${value ? 'Dados presentes' : 'Vazio'}`)
                })
            }
        }

        async function testarProtecao() {
            log('üõ°Ô∏è Testando l√≥gica de prote√ß√£o...')
            
            if (!supabase) await initSupabase()
            
            const { data: { session } } = await supabase.auth.getSession()
            
            if (session) {
                log('‚úÖ L√≥gica de prote√ß√£o: ACESSO PERMITIDO', 'success')
            } else {
                log('‚ùå L√≥gica de prote√ß√£o: ACESSO NEGADO', 'error')
            }
        }

        // Inicializar ao carregar
        document.addEventListener('DOMContentLoaded', () => {
            verificarSessao()
            
            // Escutar mudan√ßas de autentica√ß√£o
            setTimeout(async () => {
                if (!supabase) await initSupabase()
                
                supabase.auth.onAuthStateChange((event, session) => {
                    log(`üîÑ Mudan√ßa de estado: ${event}`)
                    
                    if (session) {
                        log(`‚úÖ Nova sess√£o detectada: ${session.user.email}`, 'success')
                    } else {
                        log('‚ùå Sess√£o removida', 'error')
                    }
                    
                    setTimeout(verificarSessao, 500)
                })
            }, 1000)
        })
    </script>
</body>
</html>